<!DOCTYPE html>
<html>
<head>
    <title>Debug Authentication</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        button { margin: 5px; padding: 10px; }
        .log { margin: 5px 0; padding: 5px; background: #f0f0f0; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Debug Authentication & CRUD Operations</h1>
    
    <div>
        <h2>Auth Status</h2>
        <button onclick="checkAuthStatus()">Check Auth Status</button>
        <button onclick="clearAuth()">Clear Auth</button>
        <button onclick="login()">Login</button>
    </div>
    
    <div>
        <h2>Exercise Operations</h2>
        <button onclick="listExercises()">List Exercises</button>
        <button onclick="createExercise()">Create Exercise</button>
        <button onclick="deleteLastExercise()">Delete Last Exercise</button>
    </div>
    
    <div>
        <h2>Goal Operations</h2>
        <button onclick="listGoals()">List Goals</button>
        <button onclick="createGoal()">Create Goal</button>
        <button onclick="updateLastGoal()">Update Last Goal</button>
    </div>
    
    <div id="output"></div>

    <script type="module">
        import { createClient } from './mock-sdk/index-browser.js';
        
        const client = createClient();
        window.client = client;
        
        let lastExerciseId = null;
        let lastGoalId = null;
        
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toISOString()}] ${message}`;
            output.insertBefore(div, output.firstChild);
            console.log(message);
        }
        
        window.checkAuthStatus = () => {
            log('=== Checking Auth Status ===');
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('authUser');
            const mockAuth = localStorage.getItem('mockAuth');
            
            log(`Token present: ${!!token}`);
            log(`User present: ${!!user}`);
            log(`Mock auth present: ${!!mockAuth}`);
            
            if (token) {
                log(`Token: ${token.substring(0, 50)}...`);
            }
            
            const authHeaders = client.auth.getAuthHeaders();
            log(`Auth headers: ${JSON.stringify(authHeaders)}`);
            
            const currentUser = client.auth.getCurrentUser();
            log(`Current user: ${JSON.stringify(currentUser)}`);
        };
        
        window.clearAuth = () => {
            log('Clearing all auth data...');
            client.auth.signOut();
            log('Auth cleared', 'success');
        };
        
        window.login = async () => {
            try {
                log('Attempting login...');
                const user = await client.auth.signIn('test@example.com', 'testpassword123');
                log(`Login successful: ${JSON.stringify(user)}`, 'success');
                
                // Check auth headers after login
                const authHeaders = client.auth.getAuthHeaders();
                log(`Auth headers after login: ${JSON.stringify(authHeaders)}`);
            } catch (error) {
                log(`Login failed: ${error.message}`, 'error');
            }
        };
        
        window.listExercises = async () => {
            try {
                log('Listing exercises...');
                const exercises = await client.entities.Exercise.list();
                log(`Found ${exercises.length} exercises`, 'success');
                if (exercises.length > 0) {
                    lastExerciseId = exercises[exercises.length - 1].id;
                    log(`Last exercise ID: ${lastExerciseId}`);
                }
            } catch (error) {
                log(`List exercises failed: ${error.message}`, 'error');
            }
        };
        
        window.createExercise = async () => {
            try {
                log('Creating exercise...');
                
                // Log the auth headers being sent
                const authHeaders = client.auth.getAuthHeaders();
                log(`Auth headers for create: ${JSON.stringify(authHeaders)}`);
                
                const exercise = await client.entities.Exercise.create({
                    name: `Debug Exercise ${Date.now()}`,
                    muscles: ['chest'],
                    equipment: ['dumbbell'],
                    difficulty: 'beginner',
                    discipline: ['strength'],
                    description: 'Created for debugging'
                });
                
                lastExerciseId = exercise.id;
                log(`Exercise created with ID: ${lastExerciseId}`, 'success');
            } catch (error) {
                log(`Create exercise failed: ${error.message}`, 'error');
            }
        };
        
        window.deleteLastExercise = async () => {
            try {
                if (!lastExerciseId) {
                    log('No exercise ID to delete', 'error');
                    return;
                }
                
                log(`Attempting to delete exercise: ${lastExerciseId}`);
                
                // Log the auth headers being sent
                const authHeaders = client.auth.getAuthHeaders();
                log(`Auth headers for delete: ${JSON.stringify(authHeaders)}`);
                
                // Try to get the exercise first
                try {
                    const exercise = await client.entities.Exercise.get(lastExerciseId);
                    log(`Exercise exists: ${exercise.name}`);
                } catch (e) {
                    log(`Could not fetch exercise: ${e.message}`, 'error');
                }
                
                const result = await client.entities.Exercise.delete(lastExerciseId);
                log(`Exercise deleted successfully: ${JSON.stringify(result)}`, 'success');
                lastExerciseId = null;
            } catch (error) {
                log(`Delete exercise failed: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
            }
        };
        
        window.listGoals = async () => {
            try {
                log('Listing goals...');
                const goals = await client.entities.Goal.list();
                log(`Found ${goals.length} goals`, 'success');
                if (goals.length > 0) {
                    lastGoalId = goals[goals.length - 1].id;
                    log(`Last goal ID: ${lastGoalId}`);
                }
            } catch (error) {
                log(`List goals failed: ${error.message}`, 'error');
            }
        };
        
        window.createGoal = async () => {
            try {
                log('Creating goal...');
                
                const authHeaders = client.auth.getAuthHeaders();
                log(`Auth headers for create: ${JSON.stringify(authHeaders)}`);
                
                const goal = await client.entities.Goal.create({
                    name: `Debug Goal ${Date.now()}`,
                    description: 'Created for debugging',
                    category: 'strength',
                    difficultyLevel: 'beginner',
                    estimatedWeeks: 4,
                    discipline: ['strength'],
                    milestones: [{
                        name: 'Week 1',
                        description: 'First week',
                        order: 1,
                        targetWeek: 1
                    }]
                });
                
                lastGoalId = goal.id;
                log(`Goal created with ID: ${lastGoalId}`, 'success');
            } catch (error) {
                log(`Create goal failed: ${error.message}`, 'error');
            }
        };
        
        window.updateLastGoal = async () => {
            try {
                if (!lastGoalId) {
                    log('No goal ID to update', 'error');
                    return;
                }
                
                log(`Attempting to update goal: ${lastGoalId}`);
                
                const authHeaders = client.auth.getAuthHeaders();
                log(`Auth headers for update: ${JSON.stringify(authHeaders)}`);
                
                const result = await client.entities.Goal.update(lastGoalId, {
                    name: `Updated Goal ${Date.now()}`
                });
                
                log(`Goal updated successfully: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`Update goal failed: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
            }
        };
        
        // Check initial status
        window.onload = () => {
            log('Page loaded, checking initial auth status...');
            checkAuthStatus();
        };
    </script>
</body>
</html>